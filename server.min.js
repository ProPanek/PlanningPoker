!function(e){var o={};function r(t){if(o[t])return o[t].exports;var s=o[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=o,r.d=function(e,o,t){r.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:t})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,o){if(1&o&&(e=r(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var s in e)r.d(t,s,function(o){return e[o]}.bind(null,s));return t},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r.p="",r(r.s=12)}([function(e,o){e.exports=require("lodash/findIndex")},function(e,o){e.exports=require("pg")},function(e,o){e.exports=require("path")},function(e,o){e.exports=require("bcrypt")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("date-and-time")},function(e,o){e.exports=require("http")},function(e,o){e.exports=require("fs")},function(e,o){e.exports=require("socket.io")},function(e,o){e.exports=require("uuid/v4")},function(e,o){e.exports=require("jira-connector")},function(e,o){e.exports=require("rollbar")},function(e,o,r){"use strict";r.r(o);var t=r(4),s=r.n(t),n=r(6),i=r.n(n),a=r(7),c=r.n(a),d=r(8),m=r.n(d),u=r(0),l=r.n(u),g=r(2),p=r.n(g),f=r(9),h=r.n(f),y=r(10),b=r.n(y),I=r(5),S=r.n(I),w=r(3),U=r.n(w),A=r(1),R=r(11);new(r.n(R).a)({accessToken:"ad6df4a89ab94a3591c267d78367ad3a",captureUncaught:!0,captureUnhandledRejections:!0});const k=process.env.PORT||5e3,v=s()(),E=i.a.createServer(v),j=m()(E,{cookie:!1});let D,T=[],_=new Map,N=new Map,x=new Map;!async function(){const e=new A.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});e.connect();try{const o=await e.query("SELECT * FROM rooms");e.end(),o.rows.map(({roomname:e,roomid:o,roompassword:r,timestamp:t,roomhistory:s,roomboardid:n})=>{const i={roomName:"",roomId:"",timestamp:"",boardId:"",user:[],game:[],gameHistory:[]};i.roomName=e,i.roomId=o,i.timestamp=t,i.gameHistory=JSON.parse(s),n&&(i.boardId=n),x.set(o,r),N.set(o,i)})}catch(e){console.log(e)}}(),j.on("connection",e=>{console.log("User -> connected to server id:",e.id),e.on("jiraLogin",({jiraLogin:o,jiraPassword:r,jiraSubdomain:t})=>{(D=new b.a({host:`${t}.atlassian.net`,basic_auth:{username:o,password:r}}))&&D.board.getAllBoards({startAt:0},function(o,r){e.emit("jiraLogin",r),console.log("Jira -> connecting and fetching boards",o),o&&e.emit("errors",{error:o})})}),e.on("jiraGetBoard",o=>{D.board.getIssuesForBacklog({boardId:o},function(o,r){let t=[];for(let e=0;e<r.issues.length;e++)t.push({id:r.issues[e].id,key:r.issues[e].key,summary:r.issues[e].fields.summary,description:r.issues[e].fields.description,comments:r.issues[e].fields.comment.comments,priorityType:r.issues[e].fields.priority.name,priorityUrl:r.issues[e].fields.priority.iconUrl,issueUrl:r.issues[e].fields.issuetype.iconUrl});e.emit("jiraGetBacklogBoard",t),console.log("Jira -> fetching singe board"),o&&e.emit("errors",{error:o})}),D.board.getIssuesForBoard({boardId:o},function(o,r){let t=[];for(let e=0;e<r.issues.length;e++)t.push({id:r.issues[e].id,key:r.issues[e].key,summary:r.issues[e].fields.summary,description:r.issues[e].fields.description,comments:r.issues[e].fields.comment.comments,priorityType:r.issues[e].fields.priority.name,priorityUrl:r.issues[e].fields.priority.iconUrl,issueUrl:r.issues[e].fields.issuetype.iconUrl});e.emit("jiraGetBoard",t),console.log("Jira -> fetching singe board"),o&&e.emit("errors",{error:o})})}),e.on("jiraSetEstimation",({issueId:o,boardId:r,estimationScore:t})=>{D.issue.setIssueEstimation({issueId:o,boardId:r,value:t},function(r){console.log(`Jira -> setting estimation for id: ${o} value: ${t}`),r&&e.emit("errors",{error:r})})}),e.on("createRoom",({userName:o,roomName:r,roomPassword:t})=>{const s={roomName:"",roomId:"",timestamp:"",boardId:"",user:[],game:[],gameHistory:[]},n=h()();let i=new Date;i=S.a.format(i,"YYYY/MM/DD HH:mm:ss"),s.user.push({userId:e.id,userName:o}),s.roomName=r,s.roomId=n,s.timestamp=i,U.a.hash(t,10,(o,t)=>{x.set(n,t),async function(e,o,r,t){const s=new A.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});s.connect(),await s.query(`INSERT INTO rooms(roomName,roomPassword,roomId,timeStamp) VALUES('${e}', '${o}', '${r}', '${t}')`,(e,o)=>{console.log(e,o),console.log("DB -> save room"),s.end()})}(r,t,n,i),o&&e.emit("errors",{error:o})}),N.set(n,s),_.set(e.id,n),T.push(s),e.join(n),e.emit("createRoom",s),j.in(n).emit("waitingFor",s.game.length),console.log("User -> Created room! RoomId:",n)}),e.on("saveBoardId",({roomId:e,boardId:o})=>{!async function(e,o){const r=new A.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});r.connect(),await r.query(`UPDATE rooms SET roomboardid = '${o}' WHERE roomId = '${e}'`,(e,o)=>{console.log(e,o),console.log("DB -> update room boardId"),r.end()})}(e,o),console.log("User -> Created room! RoomId:",RoomId)}),setInterval(()=>{e.emit("fetchRooms",T)},1e3),e.on("joinRoom",({roomId:o,roomPassword:r,userName:t})=>{if(N.has(o)){let s=N.get(o);console.log(s);const n=x.get(o);U.a.compare(r,n,function(r,n){if(n){let r=new Date;r=S.a.format(r,"YYYY/MM/DD HH:mm:ss"),s.timestamp=r,async function(e,o){const r=new A.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});r.connect(),await r.query(`UPDATE rooms SET timestamp = '${o}' WHERE roomId = '${e}'`,(e,o)=>{console.log(e,o),console.log("DB -> update room timestamp"),r.end()})}(o,r),s.user.push({userId:e.id,userName:t}),_.set(e.id,o),e.join(o);let n=l()(s,function(e){return e.roomId===o});-1!==n&&T[n].user.push({userId:e.id,userName:t}),console.log("User -> Joined room! RoomId:",o),e.emit("joinRoom",s),N.set(o,s),j.in(o).emit("waitingFor",s.game.length),1===s.user.length&&j.in(o).emit("changeAdmin",s.user[0].userId),console.log(s)}else e.emit("errors",{error:"Invalid Password"})})}else e.emit("errors",{error:"Room not found"})}),e.on("deleteRoom",({roomId:o,roomPassword:r})=>{if(x.has(o)){const t=x.get(o);U.a.compare(r,t,function(r,t){if(t){let r=l()(T,function(e){return e.roomId===o});T.splice(r,1),N.delete(o),async function(e){const o=new A.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});o.connect(),await o.query(`DELETE FROM rooms WHERE roomId = '${e}'`,(e,r)=>{console.log(e,r),console.log("DB -> delete room"),o.end()})}(o),e.emit("deleteRoom"),console.log("User -> Deleted room! RoomId:",o)}else e.emit("errors",{error:"Invalid Password (delete)"})})}}),e.on("sendCard",({roomId:e,userName:o,cardValue:r})=>{if(N.has(e)){let t=N.get(e);t.game.push({userName:o,cardValue:r});let s=l()(t.user,function(e){return e.userName===o});t.user[s].userName=`${t.user[s].userName} - âœ”`,t.user.length===t.game.length?(j.in(e).emit("sendCard",t.game),j.in(e).emit("waitingFor",t.game.length)):j.in(e).emit("waitingFor",t.game.length),N.set(e,t)}}),e.on("resetCards",({roomId:e})=>{if(N.has(e)){let o=N.get(e);for(let e=0;e<o.user.length;e++){let r=o.user[e].userName.split(" - ");o.user[e].userName=r[0]}o.gameHistory.push(o.game),j.in(e).emit("resetCards",o.gameHistory),!async function(e,o){const r=new A.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});r.connect(),await r.query(`UPDATE rooms SET roomhistory = '${o}' WHERE roomId = '${e}'`,(e,o)=>{console.log(e,o),console.log("DB -> update room history"),r.end()})}(e,JSON.stringify(o.gameHistory)),o.game=[],o.title="",o.description="",j.in(e).emit("waitingFor",o.game.length),N.set(e,o)}}),e.on("fetchUsers",({roomId:e})=>{if(N.has(e)){const o=N.get(e);j.in(e).emit("fetchUsers",o.user),1===o.user.length&&j.in(e.toString()).emit("changeAdmin",o.user[0].userId)}}),e.on("kickUser",({userId:o})=>{if(_.has(o)){let e=_.get(o),r=N.get(e.toString()),t=l()(r.user,function(e){return e.userId===o});-1!==t&&(j.in(e.toString()).emit("kickUser",r.user[t]),r.user.splice(t,1),j.in(e.toString()).emit("waitingFor",r.game.length),1===r.user.length&&j.in(e.toString()).emit("changeAdmin",r.user[0].userId),N.set(e.toString(),r),console.log("User -> kicked"))}else e.emit("errors",{error:"Cant find user you trying to kick"})}),e.on("changeAdmin",({userId:o})=>{if(_.has(o)){let e=_.get(o),r=N.get(e.toString()),t=l()(r.user,function(e){return e.userId===o});-1!==t&&(j.in(e.toString()).emit("changeAdmin",r.user[t].userId),console.log("User -> admin permissions given"))}else e.emit("errors",{error:"Cant find user you trying to give admin"})}),e.on("broadcastTitle",({roomId:o,title:r})=>{if(N.has(o)){let t=N.get(o);t.title!==r&&(t.title=r,e.broadcast.to(o).emit("broadcastTitle",r),N.set(o,t))}}),e.on("broadcastDescription",({roomId:o,description:r})=>{if(N.has(o)){let t=N.get(o);t.description!==r&&(t.description=r,e.broadcast.to(o).emit("broadcastDescription",r),N.set(o,t))}}),e.on("disconnect",()=>{if(_.has(e.id)){let o=_.get(e.id);if(N.has(o.toString())){let r=N.get(o.toString()),t=l()(r.user,function(o){return o.userId===e.id});-1!==t&&(r.user.splice(t,1),j.in(o.toString()).emit("waitingFor",r.game.length),1===r.user.length&&j.in(o.toString()).emit("changeAdmin",r.user[0].userId),N.set(o.toString(),r),console.log("User -> disconnected from room"))}}console.log("User -> disconnected from server")}),e.on("disconnecting",e=>{console.log("User -> disconnecting reason:",e)}),e.on("reconnecting",e=>{console.log("User -> lost connection in process of reconnection reason:",e)}),e.on("reconnect",()=>{console.log("User -> user reconnected")})}),v.use(s.a.static(p.a.join(__dirname,"client/build"))),v.get("/room/*/:uuid",function(e,o,r){const{uuid:t}=e.params;if(console.log("Room not found!: ",t),N.has(t))r();else{const e=c.a.readFileSync(p.a.join(__dirname,"client/build/index.html"),"utf-8").replace("</body>","\n      <script>\n        window.__ROOM_NOT_FOUND__ = true\n      <\/script>\n    </body>");o.status(404).send(e)}}),v.get("*",function(e,o){o.sendFile("index.html",{root:p.a.join(__dirname,"client/build")})}),E.listen(k,()=>console.log(`Listening on port ${k}`))}]);