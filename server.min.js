!function(e){var r={};function o(t){if(r[t])return r[t].exports;var i=r[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=e,o.c=r,o.d=function(e,r,t){o.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,r){if(1&r&&(e=o(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(o.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var i in e)o.d(t,i,function(r){return e[r]}.bind(null,i));return t},o.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(r,"a",r),r},o.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},o.p="",o(o.s=9)}([function(e,r){e.exports=require("lodash/findIndex")},function(e,r){e.exports=require("bcrypt")},function(e,r){e.exports=require("express")},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("http")},function(e,r){e.exports=require("socket.io")},function(e,r){e.exports=require("uuid/v4")},function(e,r){e.exports=require("jira-connector")},function(e,r){e.exports=require("date-and-time")},function(e,r,o){"use strict";o.r(r);var t=o(2),i=o.n(t),s=o(4),n=o.n(s),a=o(5),u=o.n(a),c=o(0),d=o.n(c),l=o(3),m=o.n(l),g=o(6),f=o.n(g),p=o(7),h=o.n(p),I=o(8),y=o.n(I),b=o(1),j=o.n(b);const v=process.env.PORT||5e3,U=i()(),S=n.a.createServer(U),w=u()(S,{cookie:!1});let x,N=[],k=new Map,P=new Map,R=new Map;w.on("connection",e=>{console.log("production"),console.log("User -> connected to server id:",e.id),e.on("jiraLogin",({jiraLogin:r,jiraPassword:o,jiraSubdomain:t})=>{(x=new h.a({host:`${t}.atlassian.net`,basic_auth:{username:r,password:o}}))&&x.board.getAllBoards({startAt:0},function(r,o){e.emit("jiraLogin",o),console.log("Jira -> connecting and fetching boards",r),r&&e.emit("errors",{error:r})})}),e.on("jiraGetBoard",r=>{x.board.getIssuesForBacklog({boardId:r},function(r,o){let t=[];for(let e=0;e<o.issues.length;e++)t.push({id:o.issues[e].id,key:o.issues[e].key,summary:o.issues[e].fields.summary,description:o.issues[e].fields.description,comments:o.issues[e].fields.comment.comments,priorityType:o.issues[e].fields.priority.name,priorityUrl:o.issues[e].fields.priority.iconUrl,issueUrl:o.issues[e].fields.issuetype.iconUrl});e.emit("jiraGetBacklogBoard",t),console.log("Jira -> fetching singe board"),r&&e.emit("errors",{error:r})}),x.board.getIssuesForBoard({boardId:r},function(r,o){let t=[];for(let e=0;e<o.issues.length;e++)t.push({id:o.issues[e].id,key:o.issues[e].key,summary:o.issues[e].fields.summary,description:o.issues[e].fields.description,comments:o.issues[e].fields.comment.comments,priorityType:o.issues[e].fields.priority.name,priorityUrl:o.issues[e].fields.priority.iconUrl,issueUrl:o.issues[e].fields.issuetype.iconUrl});e.emit("jiraGetBoard",t),console.log("Jira -> fetching singe board"),r&&e.emit("errors",{error:r})})}),e.on("jiraSetEstimation",({issueId:r,boardId:o,estimationScore:t})=>{x.issue.setIssueEstimation({issueId:r,boardId:o,value:t},function(o){console.log(`Jira -> setting estimation for id: ${r} value: ${t}`),o&&e.emit("errors",{error:o})})}),e.on("createRoom",({userName:r,roomName:o,roomPassword:t})=>{const i={roomName:"",roomId:"",createTimestamp:"",user:[],game:[],gameHistory:[]},s=f()();let n=new Date;n=y.a.format(n,"YYYY/MM/DD HH:mm:ss"),i.user.push({userId:e.id,userName:r}),i.roomName=o,i.roomId=s,i.createTimestamp=n,j.a.hash(t,10,function(r,o){R.set(s,o),r&&e.emit("errors",{error:r})}),P.set(s,i),k.set(e.id,s),N.push(i),e.join(s),e.emit("createRoom",i),w.in(s).emit("waitingFor",i.game.length),console.log("User -> Created room! RoomId:",s)}),setInterval(()=>{e.emit("fetchRooms",N)},1e3),e.on("joinRoom",({roomId:r,roomPassword:o,userName:t})=>{let i=P.get(r);if(i){const s=R.get(r);j.a.compare(o,s,function(o,s){if(s){i.user.push({userId:e.id,userName:t}),k.set(e.id,r),e.join(r);let o=d()(i,function(e){return e.roomId===r});-1!==o&&N[o].user.push({userId:e.id,userName:t}),console.log("User -> Joined room! RoomId:",r),e.emit("joinRoom",i),P.set(r,i),w.in(r).emit("waitingFor",i.game.length)}else e.emit("errors",{error:"Invalid Password"})})}else e.emit("errors",{error:"Room not found"})}),e.on("deleteRoom",({roomId:r,roomPassword:o})=>{const t=R.get(r);j.a.compare(o,t,function(o,t){if(t){let e=d()(N,function(e){return e.roomId===r});N.splice(e,1),P.delete(r),console.log("User -> Deleted room! RoomId:",r)}else e.emit("errors",{error:"Invalid Password (delete)"})})}),e.on("sendCard",({roomId:e,userName:r,cardValue:o})=>{let t=P.get(e);if(t){t.game.push({userName:r,cardValue:o});let i=d()(t.user,function(e){return e.userName===r});t.user[i].userName=`${t.user[i].userName} - âœ”`,t.user.length===t.game.length?(w.in(e).emit("sendCard",t.game),w.in(e).emit("waitingFor",t.game.length)):w.in(e).emit("waitingFor",t.game.length),P.set(e,t)}}),e.on("resetCards",({roomId:e})=>{let r=P.get(e);if(r){for(let e=0;e<r.user.length;e++){let o=r.user[e].userName.split(" - ");r.user[e].userName=o[0]}r.gameHistory.push(r.game),w.in(e).emit("resetCards",r.gameHistory),r.game=[],r.title="",r.description="",w.in(e).emit("waitingFor",r.game.length),P.set(e,r)}}),e.on("fetchUsers",({roomId:e})=>{setInterval(()=>{const r=P.get(e);r&&(w.in(e).emit("fetchUsers",r.user),1===r.user.length&&w.in(e.toString()).emit("changeAdmin",r.user[0].userId))},1e3)}),e.on("kickUser",({userId:e})=>{let r=k.get(e);if(r){let o=P.get(r.toString()),t=d()(o.user,function(r){return r.userId===e});-1!==t&&(w.in(r.toString()).emit("kickUser",o.user[t]),o.user.splice(t,1),w.in(r.toString()).emit("waitingFor",o.game.length),1===o.user.length&&w.in(r.toString()).emit("changeAdmin",o.user[0].userId),P.set(r.toString(),o),console.log("User -> kicked"))}}),e.on("changeAdmin",({userId:e})=>{let r=k.get(e);if(r){let o=P.get(r.toString()),t=d()(o.user,function(r){return r.userId===e});-1!==t&&(w.in(r.toString()).emit("changeAdmin",o.user[t].userId),console.log("User -> admin permissions given"))}}),e.on("broadcastTitle",({roomId:r,title:o})=>{let t=P.get(r);t.title!==o&&(t.title=o,e.broadcast.to(r).emit("broadcastTitle",o),P.set(r,t))}),e.on("broadcastDescription",({roomId:r,description:o})=>{let t=P.get(r);t.description!==o&&(t.description=o,e.broadcast.to(r).emit("broadcastDescription",o),P.set(r,t))}),e.on("disconnect",()=>{let r=k.get(e.id);if(void 0!==r){let o=P.get(r.toString());if(void 0!==o){let t=d()(o.user,function(r){return r.userId===e.id});-1!==t&&(o.user.splice(t,1),w.in(r.toString()).emit("waitingFor",o.game.length),1===o.user.length&&w.in(r.toString()).emit("changeAdmin",o.user[0].userId),P.set(r.toString(),o),console.log("User -> disconnected from room"))}}console.log("User -> disconnected from server")}),e.on("disconnecting",e=>{console.log("User -> disconnecting reason:",e)}),e.on("reconnecting",e=>{console.log("User -> lost connection in process of reconnection reason:",e)}),e.on("reconnect",()=>{console.log("User -> user reconnected")})}),U.use(i.a.static(m.a.join(__dirname,"client/build"))),U.get("/room/.*?/:uuid",function(e,r,o){const{uuid:t}=e.params;P.has(t)?o():r.status(404)}),U.get("*",function(e,r){r.sendFile("index.html",{root:m.a.join(__dirname,"client/build")})}),S.listen(v,()=>console.log(`Listening on port ${v}`))}]);