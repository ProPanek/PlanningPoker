!function(e){var o={};function r(t){if(o[t])return o[t].exports;var n=o[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=o,r.d=function(e,o,t){r.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:t})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,o){if(1&o&&(e=r(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var n in e)r.d(t,n,function(o){return e[o]}.bind(null,n));return t},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r.p="",r(r.s=13)}([function(e,o){e.exports=require("lodash/findIndex")},function(e,o){e.exports=require("pg")},function(e,o){e.exports=require("path")},function(e,o){e.exports=require("bcrypt")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("date-and-time")},function(e,o){e.exports=require("http")},function(e,o){e.exports=require("fs")},function(e,o){e.exports=require("socket.io")},function(e,o){e.exports=require("uuid/v4")},function(e,o){e.exports=require("jira-connector")},function(e,o){e.exports=require("rollbar")},function(e,o){e.exports=require("pg/lib")},function(e,o,r){"use strict";r.r(o);var t=r(4),n=r.n(t),s=r(6),i=r.n(s),a=r(7),c=r.n(a),u=r(8),l=r.n(u),d=r(0),m=r.n(d),g=r(2),f=r.n(g),p=r(9),h=r.n(p),b=r(10),y=r.n(b),I=r(5),w=r.n(I),S=r(3),U=r.n(S),k=r(1),v=r(11),R=r.n(v);r(14)();new R.a({accessToken:"ad6df4a89ab94a3591c267d78367ad3a",captureUncaught:!0,captureUnhandledRejections:!0});const A=process.env.PORT||5e3,j=n()(),E=i.a.createServer(j),D=l()(E,{cookie:!1});let T,x=[],_=new Map,N=new Map,P=new Map;!async function(){const e=new k.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await e.connect();try{const o=await e.query("SELECT * FROM rooms");e.end(),o.rows.map(({roomname:e,roomid:o,roompassword:r,timestamp:t,roomhistory:n,roomboardid:s})=>{const i={roomName:"",roomId:"",timestamp:"",boardId:"",user:[],game:[],gameHistory:[]};i.roomName=e,i.roomId=o,i.timestamp=t,i.gameHistory=n,s&&(i.boardId=s),P.set(o,r),N.set(o,i)})}catch(e){console.log(e)}}(),D.on("connection",e=>{console.log("User -> connected to server id:",e.id),e.on("jiraLogin",({jiraLogin:o,jiraPassword:r,jiraSubdomain:t})=>{(T=new y.a({host:`${t}.atlassian.net`,basic_auth:{username:o,password:r}}))&&T.board.getAllBoards({startAt:0},function(o,r){e.emit("jiraLogin",r),console.log("Jira -> connecting and fetching boards",o),o&&e.emit("errors",{error:o})})}),e.on("jiraGetBoard",o=>{T.board.getIssuesForBacklog({boardId:o},function(o,r){if(r.issues.length>0){let t=[];for(let e=0;e<r.issues.length;e++)t.push({id:r.issues[e].id,key:r.issues[e].key,summary:r.issues[e].fields.summary,description:r.issues[e].fields.description,comments:r.issues[e].fields.comment.comments,priorityType:r.issues[e].fields.priority.name,priorityUrl:r.issues[e].fields.priority.iconUrl,issueUrl:r.issues[e].fields.issuetype.iconUrl});e.emit("jiraGetBacklogBoard",t),console.log("Jira -> fetching singe board"),o&&e.emit("errors",{error:o})}}),T.board.getIssuesForBoard({boardId:o},function(o,r){if(r.issues.length>0){let t=[];for(let e=0;e<r.issues.length;e++)t.push({id:r.issues[e].id,key:r.issues[e].key,summary:r.issues[e].fields.summary,description:r.issues[e].fields.description,comments:r.issues[e].fields.comment.comments,priorityType:r.issues[e].fields.priority.name,priorityUrl:r.issues[e].fields.priority.iconUrl,issueUrl:r.issues[e].fields.issuetype.iconUrl});e.emit("jiraGetBoard",t),console.log("Jira -> fetching singe board"),o&&e.emit("errors",{error:o})}})}),e.on("jiraSetEstimation",({issueId:o,boardId:r,estimationScore:t})=>{T.issue.setIssueEstimation({issueId:o,boardId:r,value:t},function(r){console.log(`Jira -> setting estimation for id: ${o} value: ${t}`),r&&e.emit("errors",{error:r})})}),e.on("createRoom",({userName:o,roomName:r,roomPassword:t})=>{const n={roomName:"",roomId:"",timestamp:"",boardId:"",user:[],game:[],gameHistory:[]},s=h()();let i=new Date;i=w.a.format(i,"YYYY/MM/DD HH:mm:ss"),n.user.push({userId:e.id,userName:o}),n.roomName=r,n.roomId=s,n.timestamp=i,U.a.hash(t,10,(o,t)=>{P.set(s,t),insertRoomToDb(r,t,s,i),o&&e.emit("errors",{error:o})}),N.set(s,n),_.set(e.id,s),x.push(n),e.join(s),e.emit("createRoom",n),D.in(s).emit("waitingFor",n.game.length),console.log("User -> Created room! RoomId:",s)}),e.on("saveBoardId",({roomId:e,boardId:o})=>{!async function(e,o){const r=new k.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await r.connect(),await r.query(`UPDATE rooms SET roomboardid = '${o}' WHERE roomId = '${e}'`,(e,o)=>{console.log(e,o),console.log("DB -> update room boardId"),r.end()})}(e,o),console.log("User -> Created room! RoomId:",e)}),setInterval(()=>{e.emit("fetchRooms",x)},1e3),e.on("joinRoom",({roomId:o,roomPassword:r,userName:t})=>{if(N.has(o)){let n=N.get(o);console.log(n);const s=P.get(o);U.a.compare(r,s,function(r,s){if(s){let r=new Date;r=w.a.format(r,"YYYY/MM/DD HH:mm:ss"),n.timestamp=r,async function(e,o){const r=new k.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await r.connect(),await r.query(`UPDATE rooms SET timestamp = '${o}' WHERE roomId = '${e}'`,(e,o)=>{console.log(e,o),console.log("DB -> update room timestamp"),r.end()})}(o,r),n.user.push({userId:e.id,userName:t}),_.set(e.id,o),e.join(o);let s=m()(n,function(e){return e.roomId===o});-1!==s&&x[s].user.push({userId:e.id,userName:t}),console.log("User -> Joined room! RoomId:",o),e.emit("joinRoom",n),N.set(o,n),D.in(o).emit("waitingFor",n.game.length),1===n.user.length&&D.in(o).emit("changeAdmin",n.user[0].userId),console.log(n)}else e.emit("errors",{error:"Invalid Password"})})}else e.emit("errors",{error:"Room not found"})}),e.on("deleteRoom",({roomId:o,roomPassword:r})=>{if(P.has(o)){const t=P.get(o);U.a.compare(r,t,function(r,t){if(t){let r=m()(x,function(e){return e.roomId===o});x.splice(r,1),N.delete(o),async function(e){const o=new k.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await o.connect(),await o.query(`DELETE FROM rooms WHERE roomId = '${e}'`,(e,r)=>{console.log(e,r),console.log("DB -> delete room"),o.end()})}(o),e.emit("deleteRoom"),console.log("User -> Deleted room! RoomId:",o)}else e.emit("errors",{error:"Invalid Password (delete)"})})}}),e.on("sendCard",({roomId:e,userName:o,cardValue:r})=>{if(N.has(e)){let t=N.get(e);t.game.push({userName:o,cardValue:r});let n=m()(t.user,function(e){return e.userName===o});t.user[n].userName=`${t.user[n].userName} - âœ”`,t.user.length===t.game.length?(D.in(e).emit("sendCard",t.game),D.in(e).emit("waitingFor",t.game.length)):D.in(e).emit("waitingFor",t.game.length),N.set(e,t)}}),e.on("resetCards",({roomId:e})=>{if(N.has(e)){let o=N.get(e);for(let e=0;e<o.user.length;e++){let r=o.user[e].userName.split(" - ");o.user[e].userName=r[0]}o.gameHistory.push(o.game),D.in(e).emit("resetCards",o.gameHistory),!async function(e,o){const r=new k.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await r.connect(),await r.query(`UPDATE rooms SET roomhistory = '${o}' WHERE roomId = '${e}'`,(e,o)=>{console.log(e,o),console.log("DB -> update room history"),r.end()})}(e,JSON.stringify(o.gameHistory)),o.game=[],o.title="",o.description="",D.in(e).emit("waitingFor",o.game.length),N.set(e,o)}}),e.on("fetchUsers",({roomId:e})=>{if(N.has(e)){const o=N.get(e);D.in(e).emit("fetchUsers",o.user),1===o.user.length&&D.in(e.toString()).emit("changeAdmin",o.user[0].userId)}}),e.on("kickUser",({userId:o})=>{if(_.has(o)){let e=_.get(o),r=N.get(e.toString()),t=m()(r.user,function(e){return e.userId===o});-1!==t&&(D.in(e.toString()).emit("kickUser",r.user[t]),r.user.splice(t,1),D.in(e.toString()).emit("waitingFor",r.game.length),1===r.user.length&&D.in(e.toString()).emit("changeAdmin",r.user[0].userId),N.set(e.toString(),r),console.log("User -> kicked"))}else e.emit("errors",{error:"Cant find user you trying to kick"})}),e.on("changeAdmin",({userId:o})=>{if(_.has(o)){let e=_.get(o),r=N.get(e.toString()),t=m()(r.user,function(e){return e.userId===o});-1!==t&&(D.in(e.toString()).emit("changeAdmin",r.user[t].userId),console.log("User -> admin permissions given"))}else e.emit("errors",{error:"Cant find user you trying to give admin"})}),e.on("broadcastTitle",({roomId:o,title:r})=>{if(N.has(o)){let t=N.get(o);t.title!==r&&(t.title=r,e.broadcast.to(o).emit("broadcastTitle",r),N.set(o,t))}}),e.on("broadcastDescription",({roomId:o,description:r})=>{if(N.has(o)){let t=N.get(o);t.description!==r&&(t.description=r,e.broadcast.to(o).emit("broadcastDescription",r),N.set(o,t))}}),e.on("disconnect",()=>{if(_.has(e.id)){let o=_.get(e.id);if(N.has(o.toString())){let r=N.get(o.toString()),t=m()(r.user,function(o){return o.userId===e.id});-1!==t&&(r.user.splice(t,1),D.in(o.toString()).emit("waitingFor",r.game.length),1===r.user.length&&D.in(o.toString()).emit("changeAdmin",r.user[0].userId),N.set(o.toString(),r),console.log("User -> disconnected from room"))}}console.log("User -> disconnected from server")}),e.on("disconnecting",e=>{console.log("User -> disconnecting reason:",e)}),e.on("reconnecting",e=>{console.log("User -> lost connection in process of reconnection reason:",e)}),e.on("reconnect",()=>{console.log("User -> user reconnected")})}),j.use(n.a.static(f.a.join(__dirname,"client/build"))),j.get("/room/*/:uuid",function(e,o,r){const{uuid:t}=e.params;if(console.log("Room not found!: ",t),N.has(t))r();else{const e=c.a.readFileSync(f.a.join(__dirname,"client/build/index.html"),"utf-8").replace("</body>","\n      <script>\n        window.__ROOM_NOT_FOUND__ = true\n      <\/script>\n    </body>");o.status(404).send(e)}}),j.get("*",function(e,o){o.sendFile("index.html",{root:f.a.join(__dirname,"client/build")})}),E.listen(A,()=>console.log(`Listening on port ${A}`))},function(e,o,r){"use strict";r.r(o),function(e){var o=r(12);e.exports=function(){this.insertRoomToDb=async function(e,r,t,n){const s=new o.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await s.connect(),await s.query(`INSERT INTO rooms(roomName,roomPassword,roomId,timeStamp) VALUES('${e}', '${r}', '${t}', '${n}')`,(e,o)=>{console.log(e,o),console.log("DB -> save room"),s.end()})},this.multiply=function(e,o){return e*o}}}.call(this,r(15)(e))},function(e,o){e.exports=function(e){if(!e.webpackPolyfill){var o=Object.create(e);o.children||(o.children=[]),Object.defineProperty(o,"loaded",{enumerable:!0,get:function(){return o.l}}),Object.defineProperty(o,"id",{enumerable:!0,get:function(){return o.i}}),Object.defineProperty(o,"exports",{enumerable:!0}),o.webpackPolyfill=1}return o}}]);